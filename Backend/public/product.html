<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Details - WarrantyVault</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(30, 41, 59, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --card-bg: rgba(15, 23, 42, 0.6);
      --text-white: #ffffff;
      --text-muted: #94a3b8;
      --glow-color: #a78bfa;
      --success: #4ade80;
      --warning: #facc15;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      min-height: 100vh;
      color: var(--text-white);
      background-color: #0f172a;
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      padding: 40px 20px;
    }

    /* Ambient Glow */
    .ambient-light {
      position: fixed;
      width: 800px;
      height: 800px;
      background: radial-gradient(circle, rgba(124, 58, 237, 0.15) 0%, rgba(0,0,0,0) 70%);
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: -1;
      pointer-events: none;
    }

    /* Container */
    .product-container {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      animation: floatUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes floatUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Navigation */
    .nav-bar {
      margin-bottom: 24px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      transform: translateX(-4px);
    }

    /* Hero Card */
    .hero-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    .hero-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--glass-border);
      padding-bottom: 20px;
    }

    .product-title {
      font-size: 2.2rem;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(to right, #fff, #c4b5fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-active { background: rgba(74, 222, 128, 0.15); color: var(--success); border: 1px solid rgba(74, 222, 128, 0.2); }
    .status-expiring { background: rgba(250, 204, 21, 0.15); color: var(--warning); border: 1px solid rgba(250, 204, 21, 0.2); }
    .status-expired { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }

    /* Quick Stats Grid */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .stat-value { font-size: 1.1rem; color: #fff; font-weight: 500; }
    .expiry-highlight { color: var(--danger); font-weight: 700; }

    /* Main Content Split */
    .content-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 30px;
    }

    .info-card, .media-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 30px;
      display: flex;
      flex-direction: column;
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Detail List */
    .detail-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding-bottom: 12px;
    }
    
    .detail-row:last-child { border-bottom: none; }

    .d-label { color: var(--text-muted); font-size: 0.95rem; }
    .d-value { color: #fff; font-weight: 500; text-align: right; }

    /* External Link Button */
    .warranty-btn {
      margin-top: 24px;
      width: 100%;
      padding: 14px;
      background: var(--primary-gradient);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.2s;
      text-decoration: none;
    }
    
    .warranty-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3); }

    /* Media Section */
    .product-image-box {
      width: 100%;
      height: 250px;
      background: rgba(0,0,0,0.2);
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }

    .product-image-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    
    .product-image-box:hover img { transform: scale(1.05); }
    
    .zoom-hint {
      position: absolute; bottom: 10px; right: 10px;
      background: rgba(0,0,0,0.6); padding: 4px 8px;
      border-radius: 6px; font-size: 0.8rem; color: #fff;
      opacity: 0; transition: opacity 0.2s;
    }
    
    .product-image-box:hover .zoom-hint { opacity: 1; }

    /* Documents */
    .doc-list { display: flex; flex-direction: column; gap: 12px; }
    
    .doc-item {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--glass-border);
      transition: background 0.2s;
    }
    
    .doc-item:hover { background: rgba(255,255,255,0.1); }
    
    .doc-info { display: flex; align-items: center; gap: 10px; color: #fff; font-size: 0.9rem; }
    
    .doc-actions { display: flex; gap: 8px; }
    
    .icon-action {
      background: transparent; border: none; color: var(--text-muted);
      cursor: pointer; transition: color 0.2s;
    }
    .icon-action:hover { color: #fff; }

    .no-data { color: var(--text-muted); font-size: 0.9rem; text-align: center; padding: 20px; font-style: italic; }

    /* Modal */
    .preview-popup {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
      z-index: 1000; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      animation: fadeIn 0.3s;
    }
    
    .preview-content {
      max-width: 90%; max-height: 80vh;
      border-radius: 12px;
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
      border: 1px solid var(--glass-border);
    }
    
    .close-modal {
      margin-top: 20px;
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--glass-border);
      color: #fff; padding: 8px 24px;
      border-radius: 50px; cursor: pointer;
      transition: background 0.2s;
    }
    .close-modal:hover { background: rgba(255,255,255,0.2); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    @media (max-width: 900px) {
      .content-grid { grid-template-columns: 1fr; }
      .hero-header { flex-direction: column; gap: 10px; }
    }
  </style>
</head>
<body>

  <div class="ambient-light"></div>

  <div class="product-container">
    
    <div class="nav-bar">
      <a href="/dashboard" class="back-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        Back to Dashboard
      </a>
    </div>

    <div class="hero-card">
      <div class="hero-header">
        <h1 class="product-title" id="productName">Loading...</h1>
        <span class="status-badge" id="statusBadge">Loading...</span>
      </div>
      
      <div class="quick-stats">
        <div class="stat-item">
          <span class="stat-label">Model</span>
          <span class="stat-value" id="model">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Serial Number</span>
          <span class="stat-value" id="serialNumber">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Purchased On</span>
          <span class="stat-value" id="purchaseDate">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Expires On</span>
          <span class="stat-value" id="expiryDate">-</span>
        </div>
      </div>
    </div>

    <div class="content-grid">
      
      <div class="info-card">
        <div class="card-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--glow-color)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          Product Details
        </div>
        
        <div class="detail-list">
          <div class="detail-row">
            <span class="d-label">Product Name</span>
            <span class="d-value" id="infoProductName">-</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Model Number</span>
            <span class="d-value" id="infoModel">-</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Serial Number</span>
            <span class="d-value" id="infoSerial">-</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Purchase Date</span>
            <span class="d-value" id="infoPurchaseDate">-</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Warranty Expiry</span>
            <span class="d-value" id="infoExpiryDate">-</span>
          </div>
        </div>

        <button id="warrantyUrlBtn" class="warranty-btn" style="display:none;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
          Visit Warranty Page
        </button>
      </div>

      <div class="media-card">
        <div class="card-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--glow-color)" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
          Product Image
        </div>
        
        <div class="product-image-box" id="productImageBox" style="display:none;">
          <img id="productImage" src="" alt="Product Image">
          <div class="zoom-hint">Click to Zoom</div>
        </div>
        <div id="noImage" class="no-data">No product image uploaded.</div>

        <div class="card-title" style="margin-top:20px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--glow-color)" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
          Documents
        </div>

        <div class="doc-list" id="docList">
          </div>
        <div id="noDocs" class="no-data">No documents uploaded.</div>

      </div>

    </div>
  </div>

  <script>
    // --- AUTH & LOGIC PRESERVED ---
    const productId = window.location.pathname.split('/').pop();
    const userId = localStorage.getItem('userId');
    const userEmail = localStorage.getItem('userEmail');

    if (!userId || !userEmail) {
      window.location.href = '/login.html';
    }

    // Modal Viewer
    function openPreview(src, type) {
      const popup = document.createElement('div');
      popup.className = 'preview-popup';
      
      let content;
      if (type === 'pdf') {
        content = `<iframe src="${src}" class="preview-content" style="width:80vw;height:80vh;"></iframe>`;
      } else {
        content = `<img src="${src}" class="preview-content" style="object-fit:contain;">`;
      }

      popup.innerHTML = `
        ${content}
        <button class="close-modal">Close Viewer</button>
      `;
      
      popup.querySelector('.close-modal').onclick = () => popup.remove();
      popup.onclick = (e) => { if(e.target === popup) popup.remove(); };
      
      document.body.appendChild(popup);
    }

    async function loadProduct() {
      try {
        const res = await fetch(`/api/products/product/${productId}?userId=${encodeURIComponent(userId)}`);
        if (!res.ok) throw new Error('Product load failed');
        
        const product = await res.json();

        // 1. Hero Section
        document.getElementById('productName').textContent = product.name;
        document.getElementById('model').textContent = product.model || '-';
        document.getElementById('serialNumber').textContent = product.serialNumber || '-';
        
        const pDate = new Date(product.purchaseDate).toLocaleDateString();
        const eDate = new Date(product.expiryDate).toLocaleDateString();
        document.getElementById('purchaseDate').textContent = pDate;
        
        const expiryEl = document.getElementById('expiryDate');
        expiryEl.textContent = eDate;

        // Expiry Logic
        const today = new Date();
        const expiry = new Date(product.expiryDate);
        if (Math.ceil((expiry - today) / (1000 * 60 * 60 * 24)) <= 30) {
            expiryEl.classList.add('expiry-highlight');
        }

        // Status Badge
        const badge = document.getElementById('statusBadge');
        if (product.status === 'Expiring Soon') {
            badge.className = 'status-badge status-expiring';
            badge.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"></circle></svg> Expiring Soon';
        } else if (product.status === 'Expired') {
            badge.className = 'status-badge status-expired';
            badge.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="12" cy="12" r="10"></circle></svg> Expired';
        } else {
            badge.className = 'status-badge status-active';
            badge.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg> Active';
        }

        // 2. Info Card
        document.getElementById('infoProductName').textContent = product.name;
        document.getElementById('infoModel').textContent = product.model || '-';
        document.getElementById('infoSerial').textContent = product.serialNumber || '-';
        document.getElementById('infoPurchaseDate').textContent = pDate;
        document.getElementById('infoExpiryDate').textContent = eDate;

        const urlBtn = document.getElementById('warrantyUrlBtn');
        if (product.warrantyUrl) {
            urlBtn.style.display = 'flex';
            urlBtn.onclick = () => window.open(product.warrantyUrl, '_blank');
        }

        // 3. Media - Image
        const imgBox = document.getElementById('productImageBox');
        const mainImg = document.getElementById('productImage');
        const noImg = document.getElementById('noImage');

        if (product.productImageUrl) {
            mainImg.src = product.productImageUrl;
            imgBox.style.display = 'flex';
            noImg.style.display = 'none';
            imgBox.onclick = () => openPreview(product.productImageUrl, 'img');
        } else {
            imgBox.style.display = 'none';
            noImg.style.display = 'block';
        }

        // 4. Media - Documents (Invoice / Warranty Card)
        const docList = document.getElementById('docList');
        const noDocs = document.getElementById('noDocs');
        docList.innerHTML = '';
        let hasDocs = false;

        // Invoice Logic
        if (product.invoiceUrl) {
            hasDocs = true;
            const isPdf = product.invoiceUrl.toLowerCase().endsWith('.pdf');
            const icon = isPdf ? 'üìÑ' : 'üñºÔ∏è';
            
            const docItem = document.createElement('div');
            docItem.className = 'doc-item';
            docItem.innerHTML = `
                <div class="doc-info">
                    <span>${icon}</span> <span>Invoice / Receipt</span>
                </div>
                <div class="doc-actions">
                    <button class="icon-action" onclick="openPreview('${product.invoiceUrl}', '${isPdf ? 'pdf' : 'img'}')" title="View">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    <a href="${product.invoiceUrl}" download class="icon-action" title="Download">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </a>
                </div>
            `;
            docList.appendChild(docItem);
        }

        // Warranty Card Logic
        if (product.warrantyCardUrl) {
            hasDocs = true;
            const docItem = document.createElement('div');
            docItem.className = 'doc-item';
            docItem.innerHTML = `
                <div class="doc-info">
                    <span>üõ°Ô∏è</span> <span>Warranty Card</span>
                </div>
                <div class="doc-actions">
                    <a href="${product.warrantyCardUrl}" download class="icon-action" title="Download">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </a>
                </div>
            `;
            docList.appendChild(docItem);
        }

        if(hasDocs) noDocs.style.display = 'none';
        else noDocs.style.display = 'block';

      } catch (err) {
        console.error(err);
        document.body.innerHTML = `<h2 style="text-align:center;color:#ef4444;margin-top:50px;">Product not found.</h2><div style="text-align:center;"><a href="/dashboard" style="color:#fff;">Back to Dashboard</a></div>`;
      }
    }

    loadProduct();
  </script>
</body>
</html>